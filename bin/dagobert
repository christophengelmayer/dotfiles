#!/usr/bin/env python
import csv, urllib, json
from os.path import expanduser

depot = {}
investment = 0
value = 0

# Read csv and fill depot dictionary
with open(expanduser("~")+'/Dropbox/Settings/dagobert.csv', 'rb') as csvfile:
    depotcsv = csv.reader(csvfile, delimiter=';')
    firstline = True
    for row in depotcsv:
        if firstline:    #skip first line
            firstline = False
            continue
        
        if row[0] in depot:
            depot[row[0]] += float(row[2])
        else:
            depot[row[0]] = float(row[2])
        investment += float(row[2])*float(row[3])

# Generate API Request
url = "http://finance.google.com/finance/info?q="
for key in depot:
    url += key + ','
response = urllib.urlopen(url)
data = json.loads(response.read()[4:])

for stock in data:
    key = stock['e'] + ':' + stock['t']
    price= float(stock['l'])
    value += depot[key] * price

percentage = value / (investment * 0.01) - 100
balance = value - investment
color = '\033[0;32m' #green
if balance < 0:
    color = '\033[0;31m' #red

print("%s%.2f \033[0;0m| %s%.2f %%" % (color, balance, color, percentage))

